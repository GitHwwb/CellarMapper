<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CellarMapper â€” Visualize Your Wine Collection</title>
<meta name="description" content="Upload your CellarTracker or Vivino CSV and explore your wines on an interactive world map with geology, soil, climate overlays, terroir descriptions, and tasting notes.">
<meta property="og:title" content="CellarMapper â€” Visualize Your Wine Collection">
<meta property="og:description" content="Interactive wine map with terroir overlays, split view, and charts. Upload your CSV and explore.">
<meta property="og:image" content="preview.png">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="CellarMapper">
<meta name="twitter:description" content="Visualize your wine collection on an interactive world map with geology, soil, and climate overlays.">
<meta name="twitter:image" content="preview.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#1a1a2e;color:#e0e0e0;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent}
html,body{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent}
html::-webkit-scrollbar,body::-webkit-scrollbar{width:6px}
html::-webkit-scrollbar-track,body::-webkit-scrollbar-track{background:transparent}
html::-webkit-scrollbar-thumb,body::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:3px}
html::-webkit-scrollbar-thumb:hover,body::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}
.leaflet-control-zoom{border:none!important;box-shadow:none!important}
.leaflet-control-zoom a{background:rgba(22,33,62,.8)!important;color:rgba(255,255,255,.6)!important;border:1px solid rgba(255,255,255,.1)!important;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);width:28px!important;height:28px!important;line-height:28px!important;font-size:14px!important}
.leaflet-control-zoom a:hover{background:rgba(22,33,62,.95)!important;color:#fff!important}
.leaflet-control-zoom-in{border-radius:6px 6px 0 0!important}
.leaflet-control-zoom-out{border-radius:0 0 6px 6px!important}
#map{height:50vh;width:100%}
#map2{height:50vh}
.header{padding:12px 24px;background:rgba(22,33,62,.95);border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.header h1{font-size:17px;color:#fff;font-weight:600;letter-spacing:-.3px}.header .stats{font-size:12px;color:rgba(255,255,255,.4);margin-left:16px;font-weight:300}
.filter-bar{padding:8px 24px;background:rgba(22,33,62,.9);display:flex;gap:6px;flex-wrap:wrap;border-bottom:1px solid rgba(255,255,255,.06)}
.fbtn{padding:5px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.1);background:transparent;color:rgba(255,255,255,.5);cursor:pointer;font-size:12px;transition:all .25s ease;letter-spacing:.2px}
.fbtn.active{color:#fff}.fbtn.active-red{background:rgba(114,47,55,.8);border-color:rgba(169,68,66,.6)}.fbtn.active-white{background:rgba(139,122,12,.8);border-color:rgba(212,175,55,.6)}.fbtn.active-rose{background:rgba(158,74,90,.8);border-color:rgba(232,160,176,.6)}.fbtn.active-neutral{background:rgba(74,85,104,.8);border-color:rgba(113,128,150,.6)}.fbtn:hover{border-color:rgba(255,255,255,.25);color:rgba(255,255,255,.8)}
.dash{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;padding:16px 24px}
.card{background:rgba(22,33,62,.8);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,.06);max-height:400px;overflow-y:auto}
.card h3{font-size:11px;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;font-weight:500}
.bar-row{display:flex;align-items:center;margin-bottom:5px;font-size:12px}
.bar-label{width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#ccc}
.bar-track{flex:1;height:14px;background:#0f3460;border-radius:3px;margin:0 8px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width .4s}
.bar-count{width:28px;text-align:right;color:#888;font-size:11px}
.fill-red{background:linear-gradient(90deg,#722f37,#a94442)}
.fill-white{background:linear-gradient(90deg,#b8960c,#d4af37)}
.fill-rose{background:linear-gradient(90deg,#d4838f,#e8a0b0)}
.fill-neutral{background:linear-gradient(90deg,#4a5568,#718096)}
.tl-wrapper{overflow-x:auto;overflow-y:visible;position:relative;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent}
.tl-wrapper::-webkit-scrollbar{height:4px}
.tl-wrapper::-webkit-scrollbar-track{background:transparent}
.tl-wrapper::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}
.tl-wrapper::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.25)}
.tl{display:flex;align-items:flex-end;gap:1px;height:100px;position:relative;min-width:100%;overflow:visible}
.tl-bar{flex:1;border-radius:2px 2px 0 0;min-width:6px;position:relative;cursor:pointer;transition:opacity .2s;z-index:1}
.tl-bar:hover{opacity:.7;z-index:50}
.tl-bar .tip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:3px 8px;border-radius:4px;font-size:10px;white-space:nowrap;z-index:100;pointer-events:none}
.tl-bar:hover .tip{display:block}
.tl-divider{position:absolute;top:0;bottom:0;width:1px;background:rgba(255,255,255,.1)}
.tl-year-row{display:flex;gap:1px;margin-top:4px;min-width:100%}
.tl-year-row span{text-align:left;font-size:9px;color:rgba(255,255,255,.35);min-width:6px;flex:1;overflow:visible;white-space:nowrap}
.leaflet-popup-content{color:#333;font-size:12px;line-height:1.5;max-height:300px;overflow-y:auto}
.pw{margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid #eee}.pw:last-child{border:0;margin:0;padding:0}
.pw-name{font-weight:600;color:#111}.pw-note{font-style:italic;color:#555;font-size:11px;margin-top:2px}
.pw-meta{color:#777;font-size:11px}
.search-bar{padding:8px 24px;background:rgba(26,26,46,.9);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.search-bar input{flex:1;padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(22,33,62,.6);color:#e0e0e0;font-size:13px;outline:none;min-width:200px;transition:border-color .2s}
.search-bar input:focus{border-color:rgba(212,175,55,.4)}
.search-bar input::placeholder{color:rgba(255,255,255,.25)}
.search-clear{background:none;border:none;color:#888;font-size:16px;cursor:pointer;padding:4px 8px}
.search-clear:hover{color:#fff}
.region-toggle{padding:5px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:transparent;color:rgba(255,255,255,.5);cursor:pointer;font-size:12px;transition:all .25s ease;letter-spacing:.2px;font-weight:400}
.region-toggle.active{background:rgba(212,175,55,.15);border-color:rgba(212,175,55,.4);color:#d4af37;font-weight:500}
.region-toggle:hover{border-color:rgba(255,255,255,.25);color:rgba(255,255,255,.8)}
.detail-panel{margin:0 24px 16px;background:rgba(22,33,62,.9);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;max-height:300px;overflow-y:auto;position:relative}
.detail-panel h4{font-size:14px;color:#fff;margin-bottom:10px;font-weight:500}
.detail-panel .close-btn{position:absolute;top:10px;right:14px;background:none;border:none;color:#888;font-size:18px;cursor:pointer}
.detail-panel .close-btn:hover{color:#fff}
.dp-wine{padding:8px 0;border-bottom:1px solid #333}.dp-wine:last-child{border:0}
.dp-name{color:#e0e0e0;font-weight:600;font-size:13px}
.dp-meta{color:#888;font-size:12px;margin-top:2px}
.dp-note{color:#aaa;font-size:12px;font-style:italic;margin-top:3px}
#map-wrapper.fullscreen{position:fixed!important;top:0;left:0;width:100vw!important;height:100vh!important;z-index:9999;background:#1a1a2e}
#map-wrapper.fullscreen #map{height:100%!important;width:100%!important}
#map-wrapper.fullscreen.split-active #map{width:50%!important;display:inline-block!important;vertical-align:top}
#map-wrapper.fullscreen.split-active #map2{display:inline-block!important;width:50%!important;height:100%!important;vertical-align:top}
.fs-btn{position:absolute;top:10px;right:10px;z-index:10000;background:#16213e;border:1px solid #555;color:#ccc;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:14px}
.fs-btn:hover{background:#333;color:#fff}
.fs-controls{display:none;position:absolute;top:10px;right:50px;z-index:10001;background:rgba(22,33,62,.92);border:1px solid #555;border-radius:6px;padding:0;max-width:200px}
.fs-ctrl-toggle{width:100%;background:none;border:none;color:#ccc;padding:8px 12px;cursor:pointer;font-size:12px;text-align:left}
.fs-ctrl-toggle:hover{color:#fff}
.fs-ctrl-body{padding:8px 12px;display:flex;flex-wrap:wrap;gap:4px}
.fs-ctrl-body .fbtn{font-size:11px;padding:3px 8px}
.fs-ctrl-body .region-toggle{font-size:11px;padding:3px 8px;width:100%}
.fs-search{width:100%;padding:5px 8px;border-radius:4px;border:1px solid #444;background:#0f3460;color:#e0e0e0;font-size:11px;outline:none;margin-top:2px}
.fs-search:focus{border-color:#722f37}
.fs-search::placeholder{color:#666}
#map-wrapper.fullscreen .fs-controls{display:block}
.geo-info{position:absolute;bottom:30px;left:10px;z-index:10000;background:rgba(22,33,62,.92);border:1px solid #555;border-radius:6px;padding:10px 14px;color:#e0e0e0;font-size:12px;max-width:320px;display:none;line-height:1.6;max-height:250px;overflow-y:auto}
.geo-info h5{margin:0 0 4px;color:#d4af37;font-size:13px}
.geo-info .geo-close{position:absolute;top:4px;right:8px;background:none;border:none;color:#888;cursor:pointer;font-size:14px}
.geo-info .geo-close:hover{color:#fff}
[id$="-legend"]{top:auto}
@media(max-width:900px){.dash{grid-template-columns:1fr}}
.region-label{background:none!important;border:none!important;box-shadow:none!important;color:#8b7355;font-size:11px;font-weight:600;letter-spacing:.5px;text-shadow:0 0 4px rgba(0,0,0,.8),0 0 8px rgba(0,0,0,.6);white-space:nowrap;pointer-events:none}

/* Landing â€” dark blue matching map theme */
#landing{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:80px 24px 60px;text-align:center;background:linear-gradient(180deg,#0d1117 0%,#151d2e 40%,#1a2540 100%);position:relative;overflow:hidden}
#landing::before{content:'';position:absolute;top:-120px;right:-80px;width:400px;height:400px;background:radial-gradient(circle,rgba(114,47,55,.04) 0%,transparent 70%);pointer-events:none}
#landing::after{content:'';position:absolute;bottom:-100px;left:-60px;width:350px;height:350px;background:radial-gradient(circle,rgba(212,175,55,.03) 0%,transparent 70%);pointer-events:none}
#landing h2{font-size:clamp(38px,5vw,56px);color:#fff;margin-bottom:12px;font-weight:300;letter-spacing:-1px}
#landing .subtitle{color:rgba(255,255,255,.45);font-size:clamp(15px,2vw,17px);max-width:520px;margin-bottom:48px;line-height:1.8;font-weight:300}
.landing-features{display:flex;gap:40px;max-width:560px;margin:0 auto 48px;text-align:center;justify-content:center}
.landing-feature{flex:1}
.landing-feature .feat-title{color:rgba(255,255,255,.7);font-size:13px;font-weight:500;margin-bottom:4px;letter-spacing:-.1px}
.landing-feature .feat-desc{color:rgba(255,255,255,.3);font-size:11px;line-height:1.5}
@media(max-width:600px){.landing-features{flex-direction:column;gap:20px;max-width:280px}}
.drop-zone{width:100%;max-width:480px;border:1.5px dashed rgba(255,255,255,.12);border-radius:20px;padding:52px 32px;cursor:pointer;transition:all .3s ease;background:rgba(22,33,62,.3);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.drop-zone:hover,.drop-zone.dragover{border-color:rgba(212,175,55,.35);background:rgba(22,33,62,.5);transform:translateY(-2px);box-shadow:0 20px 60px rgba(0,0,0,.2)}
.drop-zone h3{color:#d4af37;font-size:17px;margin-bottom:6px;font-weight:400}
.drop-zone p{color:rgba(255,255,255,.3);font-size:13px;margin:0}
.drop-zone input{display:none}
#upload-error{color:#a94442;font-size:13px;margin-top:12px;display:none}
#upload-info{color:rgba(255,255,255,.4);font-size:13px;margin-top:40px;max-width:480px;text-align:left;line-height:1.7;background:rgba(22,33,62,.3);border-radius:12px;padding:16px 20px;border:1px solid rgba(255,255,255,.05)}
#upload-info summary{cursor:pointer;color:rgba(255,255,255,.6);font-size:14px;font-weight:400}
#upload-info a{color:#d4af37;text-decoration:none;border-bottom:1px solid rgba(212,175,55,.25);transition:border-color .2s}
#upload-info a:hover{border-color:#d4af37}
#upload-info b{color:rgba(255,255,255,.6)}
.landing-bmc{margin-top:32px;transform:scale(0.8);transform-origin:center center}
#app{display:none}
</style>
</head>
<body>

<!-- Landing screen -->
<div id="landing">
<h2>CellarMapper</h2>
<p class="subtitle">Your wine collection, visualized. Explore terroir, geology, soil, and climate overlays on an interactive world map.</p>

<div class="landing-features">
<div class="landing-feature">
<div class="feat-title">Terroir Overlays</div>
<div class="feat-desc">Geology, soil, climate, elevation, and cropland layers</div>
</div>
<div class="landing-feature">
<div class="feat-title">Collection Insights</div>
<div class="feat-desc">Charts by country, varietal, and timeline</div>
</div>
<div class="landing-feature">
<div class="feat-title">Tasting Notes</div>
<div class="feat-desc">Your notes pinned to each wine's origin</div>
</div>
</div>

<img src="preview.png" alt="CellarMapper preview showing wine regions with geology overlay" style="width:100%;max-width:680px;border-radius:16px;border:1px solid rgba(255,255,255,.06);margin-bottom:48px;display:none;box-shadow:0 24px 80px rgba(0,0,0,.3)" id="preview-img" onload="this.style.display='block'" onerror="this.style.display='none'">

<div class="drop-zone" id="drop-zone">
<h3>Drop your CSV here</h3>
<p>or click to browse</p>
<input type="file" id="csv-input" accept=".csv,.txt">
</div>
<div id="upload-error"></div>
<details id="upload-info">
<summary>How to export your data</summary>
<br>
<b>CellarTracker</b> <span style="color:#d4af37;font-size:11px">(recommended â€” richest data)</span><br>
Follow the official guide: <a href="https://support.cellartracker.com/article/29-exporting-data" target="_blank">Exporting Data from CellarTracker</a><br><br>
<b>Vivino</b> <span style="color:rgba(255,255,255,.35);font-size:11px">(limited â€” no tasting notes, type, or appellation)</span><br>
Vivino doesn't have a native export. Use the <a href="https://github.com/sulfo/Vivino-Exporter" target="_blank">Vivino Exporter</a> browser extension to export your wines as CSV, then upload here.<br><br>
<b>Other apps</b><br>
Any CSV works if it has at minimum a <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Wine</code> and <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Country</code> column. Additional supported columns: <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Vintage</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Region</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">SubRegion</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Appellation</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Varietal</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Color</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Type</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Consumed</code>, <code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-size:11px">Note</code>. Missing columns are skipped gracefully.
</details>
<div class="landing-bmc"><script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="Jon.L" data-color="#9196a0" data-emoji="ðŸ·" data-font="Cookie" data-text="Buy me a glass" data-outline-color="#9196a0" data-font-color="#000000" data-coffee-color="#FFDD00" ></script></div>
</div>

<!-- App (hidden until CSV loaded) -->
<div id="app">
<div class="header">
<h1>CellarMapper</h1>
<div class="stats" id="stats"></div>
<button class="region-toggle" id="split-toggle" onclick="toggleSplit()" style="margin-left:8px;font-size:11px">Split View</button>
<button class="fbtn" onclick="resetApp()" style="margin-left:8px;font-size:11px;border-style:dashed">New CSV</button>
<div style="margin-left:auto;transform:scale(0.65);transform-origin:right center" id="header-bmc"><script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="Jon.L" data-color="#9196a0" data-emoji="ðŸ·" data-font="Cookie" data-text="Buy me a glass" data-outline-color="#9196a0" data-font-color="#000000" data-coffee-color="#FFDD00" ></script></div>
</div>
<div class="filter-bar" id="filters"></div>
<div class="search-bar">
<button class="region-toggle" id="region-toggle" onclick="toggleRegions()">Regions</button>
<button class="region-toggle" id="geo-toggle" onclick="toggleGeology()">Geology</button>
<button class="region-toggle" id="climate-toggle" onclick="toggleClimate()">Climate</button>
<button class="region-toggle" id="elev-toggle" onclick="toggleElevation()">Elevation</button>
<button class="region-toggle" id="sat-toggle" onclick="toggleSatellite()">Satellite</button>
<button class="region-toggle" id="soil-toggle" onclick="toggleSoil()">Soil</button>
<button class="region-toggle" id="crop-toggle" onclick="toggleCropland()">Cropland</button>
<input type="text" id="wine-search" placeholder="Search wines by name, varietal, region, notes..." oninput="doSearch(this.value)">
<button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none">âœ•</button>
</div>
<div style="position:relative" id="map-wrapper">
<div id="map"></div><div id="map2" style="display:none"></div>
<button class="fs-btn" id="fs-btn" onclick="toggleFullscreen()">â›¶</button>
<div class="fs-controls" id="fs-controls">
<button class="fs-ctrl-toggle" id="fs-ctrl-toggle" onclick="toggleFsControls()">â–¼ Controls</button>
<div class="fs-ctrl-body" id="fs-ctrl-body">
<button class="fbtn" onclick="if(window._buildFilters){activeFilters.clear();window._buildFilters();applyTheme();updateAll()}">All</button>
<button class="fbtn" onclick="fsFilter('Red')">Red</button>
<button class="fbtn" onclick="fsFilter('White')">White</button>
<button class="fbtn" onclick="fsFilter('RosÃ©')">RosÃ©</button>
<hr style="border-color:#444;margin:6px 0;width:100%">
<button class="region-toggle" onclick="toggleRegions();syncFsBtn(this,'region-toggle')">Regions</button>
<button class="region-toggle" onclick="toggleGeology();syncFsBtn(this,'geo-toggle')">Geology</button>
<button class="region-toggle" onclick="toggleClimate();syncFsBtn(this,'climate-toggle')">Climate</button>
<button class="region-toggle" onclick="toggleElevation();syncFsBtn(this,'elev-toggle')">Elevation</button>
<button class="region-toggle" onclick="toggleSatellite();syncFsBtn(this,'sat-toggle')">Satellite</button>
<button class="region-toggle" onclick="toggleSoil();syncFsBtn(this,'soil-toggle')">Soil</button>
<button class="region-toggle" onclick="toggleCropland();syncFsBtn(this,'crop-toggle')">Cropland</button>
<hr style="border-color:#444;margin:6px 0;width:100%">
<input type="text" class="fs-search" placeholder="Search wines..." oninput="doSearch(this.value);document.getElementById('wine-search').value=this.value">
</div>
</div>
<div class="geo-info" id="geo-info"><button class="geo-close" onclick="hideGeoInfo()">âœ•</button><div id="geo-content"></div></div>
</div>
<div class="dash">
<div class="card"><h3>By Country</h3><div id="c-country"></div></div>
<div class="card"><h3>Top Varietals</h3><div id="c-varietal"></div></div>
<div class="card"><h3>Timeline</h3><div id="c-timeline"></div></div>
</div>
<div id="detail-panel" class="detail-panel" style="display:none"></div>
</div>

<script>
// ===== GEO CACHE â€” curated wine regions + dynamic geocoding fallback =====
const GEO={
"California":[36.77,-119.42],"Napa Valley":[38.50,-122.27],"Sonoma County":[38.52,-122.81],
"Central Coast":[35.28,-120.66],"Monterey":[36.24,-121.77],"Carneros":[38.25,-122.37],
"Russian River Valley":[38.52,-122.88],"Sonoma Coast":[38.45,-123.05],"Sta. Rita Hills":[34.63,-120.47],
"Paso Robles":[35.63,-120.69],"Santa Barbara County":[34.71,-119.99],"Anderson Valley":[39.07,-123.36],
"Spring Mountain District":[38.55,-122.52],"Napa / Sonoma":[38.40,-122.40],"North Coast":[39.0,-123.0],
"Calistoga":[38.58,-122.58],"Stags Leap District":[38.40,-122.35],"Oak Knoll District":[38.35,-122.32],
"Coombsville":[38.28,-122.22],"Alexander Valley":[38.72,-122.85],"Dry Creek Valley":[38.68,-122.93],
"Sonoma Mountain":[38.38,-122.60],"Lodi":[38.13,-121.27],"Santa Lucia Highlands":[36.38,-121.35],
"Santa Maria Valley":[34.95,-120.44],"Mendocino County":[39.15,-123.20],
"Rutherford":[38.45,-122.42],"St. Helena":[38.51,-122.47],"Howell Mountain":[38.55,-122.42],
"Mount Veeder":[38.38,-122.48],"Atlas Peak":[38.42,-122.25],"Yountville":[38.40,-122.36],
"Chalk Hill":[38.60,-122.75],"Knights Valley":[38.65,-122.65],"Santa Cruz Mountains":[37.15,-122.05],
"Livermore Valley":[37.68,-121.77],"Sierra Foothills":[38.75,-120.80],"Temecula Valley":[33.49,-117.10],
"Santa Ynez Valley":[34.73,-120.08],"Edna Valley":[35.18,-120.60],"Arroyo Grande Valley":[35.12,-120.58],
"Willamette Valley":[45.07,-123.07],"Eola - Amity Hills":[44.95,-123.15],"Oregon":[44.0,-120.5],
"Washington":[46.73,-120.74],"Columbia Valley":[46.5,-119.5],"Horse Heaven Hills":[46.0,-119.5],
"Red Mountain":[46.30,-119.48],"Walla Walla Valley":[46.07,-118.33],"Dundee Hills":[45.28,-123.05],
"Ribbon Ridge":[45.35,-123.08],"Chehalem Mountains":[45.35,-122.95],"McMinnville":[45.21,-123.20],
"Yamhill-Carlton":[45.35,-123.18],"Yakima Valley":[46.60,-120.50],
"Finger Lakes":[42.65,-76.95],"Long Island":[40.92,-72.65],"New Jersey":[39.83,-74.87],"Virginia":[38.00,-79.50],
"Burgundy":[47.04,4.84],"CÃ´te de Nuits":[47.15,4.95],"CÃ´te de Beaune":[46.95,4.85],
"Beaujolais":[46.15,4.65],"Chablis":[47.81,3.80],"Bourgogne-Chitry":[47.80,3.72],
"MÃ¢connais":[46.30,4.80],"CÃ´te Chalonnaise":[46.75,4.75],
"Champagne":[49.25,3.96],"Bordeaux":[44.84,-0.58],"Libournais":[44.92,-0.15],
"MÃ©doc":[45.15,-0.85],"Haut-MÃ©doc":[45.05,-0.75],"Saint-Ã‰milion":[44.89,-0.15],
"Pomerol":[44.93,-0.20],"Margaux":[45.04,-0.67],"Pauillac":[45.20,-0.75],
"Saint-Julien":[45.16,-0.74],"Saint-EstÃ¨phe":[45.26,-0.77],"Pessac-LÃ©ognan":[44.73,-0.60],
"Graves":[44.60,-0.50],"Sauternes":[44.55,-0.35],"CÃ´tes de Bourg":[45.04,-0.56],
"RhÃ´ne":[44.12,4.81],"Northern RhÃ´ne":[45.15,4.85],"Southern RhÃ´ne":[44.06,4.83],
"ChÃ¢teauneuf-du-Pape":[44.06,4.83],"Hermitage":[45.08,4.84],"CÃ´te-RÃ´tie":[45.47,4.82],
"Crozes-Hermitage":[45.05,4.85],"Saint-Joseph":[45.20,4.82],"Cornas":[44.96,4.85],
"Condrieu":[45.45,4.78],"Gigondas":[44.17,5.00],"Vacqueyras":[44.15,4.98],
"Languedoc Roussillon":[43.61,3.88],"Languedoc":[43.61,3.88],"Roussillon":[42.70,2.90],
"Loire Valley":[47.38,0.69],"Upper Loire":[47.33,2.83],"Sancerre":[47.33,2.83],
"Pouilly-FumÃ©":[47.28,2.95],"Vouvray":[47.40,0.80],"Muscadet":[47.10,-1.55],
"Alsace":[48.20,7.35],"Provence":[43.50,6.20],"Bandol":[43.18,5.75],
"CÃ´tes de Provence":[43.45,6.25],"Jura":[46.75,5.85],"Corsica":[42.15,9.10],
"Cahors":[44.45,1.44],"Bergerac":[44.85,0.48],
"Mosel Saar Ruwer":[49.73,6.63],"Mosel":[49.73,6.63],"Rheinhessen":[49.85,8.27],
"Baden":[48.50,8.20],"Pfalz":[49.35,8.15],"Rheingau":[50.02,8.05],
"Nahe":[49.80,7.85],"Franken":[49.80,10.00],"WÃ¼rttemberg":[48.80,9.20],
"Piedmont":[44.69,8.04],"Langhe":[44.60,8.00],"Barolo":[44.60,7.94],
"Barbaresco":[44.73,8.08],"Tuscany":[43.35,11.32],"Chianti":[43.47,11.25],
"Chianti Classico":[43.47,11.25],"Brunello di Montalcino":[43.06,11.49],
"Bolgheri":[43.23,10.62],"Campania":[40.83,14.25],"Puglia":[41.13,16.87],
"Veneto":[45.44,10.99],"Valpolicella":[45.52,10.88],"Sardinia":[39.22,9.12],
"Sicily":[37.60,14.27],"Etna":[37.75,15.00],"Trentino-Alto Adige":[46.07,11.12],
"Trentino Alto-Adige / Veneto":[46.07,11.12],"Friuli Venezia Giulia":[45.95,13.40],
"Abruzzo":[42.35,13.40],"Umbria":[42.73,12.39],"Lombardy":[45.47,9.19],
"Franciacorta":[45.60,10.05],"Soave":[45.42,11.25],"Prosecco":[45.90,12.00],
"Catalunya":[41.59,1.52],"Tarragona":[41.12,1.25],"La Rioja":[42.47,-2.45],
"Rioja":[42.47,-2.45],"Ribera del Duero":[41.65,-3.70],"Priorat":[41.20,0.85],
"PenedÃ¨s":[41.35,1.70],"Montsant":[41.12,1.25],"RÃ­as Baixas":[42.30,-8.70],
"Rueda":[41.40,-4.95],"Toro":[41.52,-5.40],"Jerez":[36.68,-6.14],
"Douro":[41.16,-7.79],"Minho":[41.56,-8.40],"Beiras":[40.64,-7.90],
"Alentejo":[38.57,-7.91],"DÃ£o":[40.52,-7.90],"Bairrada":[40.38,-8.45],
"Madeira":[32.65,-16.91],"Vinho Verde":[41.56,-8.40],
"Barossa Valley":[-34.56,138.95],"McLaren Vale":[-35.22,138.55],"Clare Valley":[-33.83,138.60],
"Eden Valley":[-34.63,139.05],"Coonawarra":[-37.29,140.83],"Margaret River":[-33.95,115.08],
"Hunter Valley":[-32.75,151.15],"Yarra Valley":[-37.75,145.50],"Mornington Peninsula":[-38.35,145.05],
"Tasmania":[-42.00,146.50],"Adelaide Hills":[-35.02,138.72],
"Marlborough":[-41.52,173.95],"Central Otago":[-45.03,169.20],"Hawke's Bay":[-39.65,176.85],
"Martinborough":[-41.22,175.47],"Waipara":[-43.05,172.75],
"Mendoza":[-32.89,-68.83],"Patagonia":[-40.80,-65.00],"Uco Valley":[-33.65,-69.25],
"LujÃ¡n de Cuyo":[-33.03,-68.88],"Salta":[-25.37,-65.40],"Cafayate":[-26.07,-66.03],
"Casablanca Valley":[-33.32,-71.41],"Aconcagua Valley":[-32.83,-70.73],
"Rapel Valley":[-34.17,-71.22],"Colchagua Valley":[-34.40,-71.22],
"Maipo Valley":[-33.50,-70.60],"Leyda":[-33.62,-71.42],
"Stellenbosch":[-33.93,18.86],"Franschhoek":[-33.87,19.12],"Swartland":[-33.45,18.75],
"Walker Bay":[-34.40,19.30],"Paarl":[-33.73,18.97],"Constantia":[-34.03,18.42],
"Galilee":[32.87,35.50],"Golan Heights":[33.00,35.75],
"Kakheti":[41.65,45.70],"Tokaj":[48.12,21.41],
"Wachau":[48.37,15.42],"Kamptal":[48.55,15.73],"Burgenland":[47.85,16.52],
"Santorini":[36.42,25.43],"Nemea":[37.82,22.66],
"Bekaa Valley":[33.85,35.90],"Okanagan Valley":[49.88,-119.50],"Niagara Peninsula":[43.10,-79.20],
"Ningxia":[38.47,106.27],"Coastal Region":[-33.93,18.42],
"USA":[39.83,-98.58],"France":[46.60,2.21],"Germany":[50.11,8.68],
"Italy":[42.50,12.57],"Spain":[40.42,-3.70],"Chile":[-33.45,-70.67],
"Portugal":[39.40,-8.22],"Argentina":[-34.60,-58.38],"Australia":[-25.27,133.78],
"New Zealand":[-41.29,174.78],"South Africa":[-33.93,18.42],
"Israel":[31.77,35.23],"Georgia":[41.72,44.79],"Hungary":[47.50,19.04],
"Austria":[48.21,16.37],"Greece":[37.98,23.73],"Lebanon":[33.89,35.50],
"Croatia":[45.10,15.20],"Slovenia":[46.05,14.51],"Canada":[43.65,-79.38],
"England":[51.10,0.50],"China":[35.86,104.20],"Japan":[35.68,139.69],
"Uruguay":[-34.88,-56.17],"Brazil":[-29.17,-51.18],"Romania":[44.43,26.10],
"Moldova":[47.01,28.86],"Bulgaria":[42.70,23.32],"Turkey":[39.93,32.85],
"India":[18.52,73.86]
};

// ===== CSV PARSER =====
// Auto-detects CellarTracker vs Vivino vs generic CSV format
function parseCSV(text){
  let lines=text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2){throw new Error('CSV has no data rows')}
  // Parse header
  let header=parseCSVLine(lines[0]);
  let headerLower=header.map(h=>h.toLowerCase().trim());
  // Detect format
  let format='generic';
  if(headerLower.includes('iwine')||headerLower.includes('mastervarietal'))format='cellartracker';
  else if(headerLower.includes('wine id')||headerLower.includes('wine name'))format='vivino';
  console.log('Detected CSV format:',format,'| Columns:',header.length,'| Rows:',lines.length-1);
  // Build column mapping
  let colMap=buildColumnMap(headerLower,format);
  // Parse rows
  let wines=[];
  for(let i=1;i<lines.length;i++){
    let vals=parseCSVLine(lines[i]);
    if(vals.length<2)continue;
    let w=mapRow(vals,colMap,headerLower);
    if(w.wine&&w.country)wines.push(w);
  }
  return{wines,format,totalRows:lines.length-1,validRows:wines.length};
}

function parseCSVLine(line){
  let result=[];let current='';let inQuotes=false;
  for(let i=0;i<line.length;i++){
    let c=line[i];
    if(c==='"'){
      if(inQuotes&&line[i+1]==='"'){current+='"';i++}
      else inQuotes=!inQuotes;
    }else if(c===','&&!inQuotes){result.push(current.trim());current=''}
    else current+=c;
  }
  result.push(current.trim());
  return result;
}

function buildColumnMap(headerLower,format){
  let m={};
  // Try exact matches first, then fuzzy
  let find=(names)=>{for(let n of names){let i=headerLower.indexOf(n);if(i>=0)return i}return-1};
  m.wine=find(['wine','wine name','name','title']);
  m.vintage=find(['vintage','year']);
  m.type=find(['type','wine type']);
  m.color=find(['color','wine color']);
  m.category=find(['category']);
  m.varietal=find(['varietal','grape','grapes','grape variety']);
  m.masterVarietal=find(['mastervarietal','master varietal','primary grape']);
  m.country=find(['country','origin country','origin_country']);
  m.region=find(['region','wine region','origin_region','origin region']);
  m.subRegion=find(['subregion','sub-region','sub region']);
  m.appellation=find(['appellation','designation','aoc','doc','ava']);
  m.vineyard=find(['vineyard']);
  m.consumed=find(['consumed','date consumed','date tasted','date','tasting date']);
  m.consumedYear=find(['consumedyear','consumed year','consumed_year']);
  m.consumedMonth=find(['consumedmonth','consumed month','consumed_month']);
  m.note=find(['consumptionnote','consumption note','tasting note','tasting notes','note','notes','review','my review']);
  m.price=find(['price','cost']);
  m.rating=find(['rating','my rating','score','user rating']);
  return m;
}

function mapRow(vals,colMap,headerLower){
  let get=(key)=>{let i=colMap[key];return i>=0&&i<vals.length?vals[i].replace(/^"|"$/g,'').trim():''};
  let wine=get('wine');
  let vintage=get('vintage');
  let type=get('type');
  let color=get('color')||type;
  let varietal=get('varietal');
  let masterVarietal=get('masterVarietal')||varietal;
  let country=get('country');
  let region=get('region');
  let subRegion=get('subRegion');
  let appellation=get('appellation');
  let consumed=get('consumed');
  let note=get('note');
  // Parse consumed date â€” use direct year/month columns if available
  let consumedYear=get('consumedYear'),consumedMonth=get('consumedMonth');
  if(!consumedYear&&consumed){
    // Try YYYY-MM-DD first (ISO format)
    let dp2=consumed.match(/^(\d{4})[\/\-](\d{1,2})/);
    if(dp2){consumedYear=dp2[1];consumedMonth=dp2[2]}
    else{
      // Try MM/DD/YYYY or M/D/YY
      let dp=consumed.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
      if(dp){consumedMonth=dp[1];consumedYear=dp[3].length===2?'20'+dp[3]:dp[3]}
    }
  }
  return{wine,vintage,type:type||'Unknown',color:color||type||'Unknown',category:get('category')||'',
    varietal:varietal||'Unknown',masterVarietal:masterVarietal||varietal||'Unknown',
    country:country||'',region:region||'',subRegion:subRegion||'Unknown',
    appellation:appellation||'Unknown',vineyard:get('vineyard')||'Unknown',
    consumed,consumedYear,consumedMonth,note,price:get('price')||'0'};
}

// ===== UPLOAD HANDLING =====
let wines=[];
const dropZone=document.getElementById('drop-zone');
const csvInput=document.getElementById('csv-input');
const uploadError=document.getElementById('upload-error');

dropZone.addEventListener('click',()=>csvInput.click());
dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('dragover')});
dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('dragover');handleFile(e.dataTransfer.files[0])});
csvInput.addEventListener('change',e=>handleFile(e.target.files[0]));

function handleFile(file){
  if(!file)return;
  uploadError.style.display='none';
  let reader=new FileReader();
  reader.onload=e=>{
    try{
      let result=parseCSV(e.target.result);
      if(result.validRows===0)throw new Error('No valid wine entries found. Make sure your CSV has Wine and Country columns.');
      wines=result.wines;
      document.getElementById('landing').style.display='none';
      document.getElementById('app').style.display='block';
      initApp();
    }catch(err){
      uploadError.textContent='Error: '+err.message;
      uploadError.style.display='block';
    }
  };
  reader.readAsText(file);
}

function resetApp(){
  wines=[];
  document.getElementById('app').style.display='none';
  document.getElementById('landing').style.display='flex';
  csvInput.value='';
}

// ===== CORE APP LOGIC =====
let map,mapLayerGroup,activeFilters=new Set();
let climateLayer,elevLayer,satLayer,soilLayer,geoLayer;
let climateVisible=false,elevVisible=false,satVisible=false,soilVisible=false,geoVisible=false,regionsVisible=false;
let splitActive=false,map2=null,map2Layers={},regionLayer,regionLayer2=null;
let countryExpanded=false,varietalExpanded=false;

// Geocoding cache for dynamic lookups
let geocodeCache={};
let _lastGeoTime=0;

async function geocodeLocation(query){
  if(geocodeCache[query]!==undefined)return geocodeCache[query];
  // Rate-limit: wait until 1.1s since last request
  let now=Date.now();
  let wait=Math.max(0,1100-( now-_lastGeoTime));
  if(wait>0)await new Promise(r=>setTimeout(r,wait));
  _lastGeoTime=Date.now();
  try{
    let resp=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`,{headers:{'User-Agent':'CellarMapper/1.0'}});
    let data=await resp.json();
    if(data&&data.length>0){
      let coords=[parseFloat(data[0].lat),parseFloat(data[0].lon)];
      geocodeCache[query]=coords;
      return coords;
    }
  }catch(e){console.log('Geocode failed:',query,e)}
  geocodeCache[query]=null;
  return null;
}

// Pre-geocode all unique locations from wine data
async function geocodeAllWines(wineList){
  // Build full location context for each unique key
  let queries=new Map();
  wineList.forEach(w=>{
    // Build location chain from most to least specific
    let parts=[w.appellation,w.subRegion,w.region,w.country].filter(k=>k&&k!=='Unknown');
    // For each level, build a query with full context
    for(let i=0;i<parts.length;i++){
      let k=parts[i];
      if(GEO[k]||queries.has(k))continue;
      // Use remaining parts as context: "Coombsville, Napa / Sonoma, California, USA"
      let contextParts=parts.slice(i);
      let query=contextParts.join(', ');
      queries.set(k,query);
    }
  });
  let total=queries.size;
  if(total===0){rebuildMap(getFiltered());return}
  let done=0;
  let statusEl=document.getElementById('stats');
  let origColor=statusEl.style.color;
  statusEl.style.color='#d4af37';
  for(let [key,query] of queries){
    if(GEO[key]){done++;continue}
    done++;
    statusEl.textContent=`Geocoding locations... ${done}/${total}`;
    let coords=await geocodeLocation(query);
    if(coords)GEO[key]=coords;
    // Rebuild map every 5 geocodes so markers appear progressively
    if(done%5===0||done===total)rebuildMap(getFiltered());
  }
  statusEl.style.color=origColor;
  updateCharts();
  rebuildMap(getFiltered());
}

function getCoords(w){
  // Check cache
  for(let k of [w.appellation,w.subRegion,w.region,w.country]){
    if(k&&k!=='Unknown'&&GEO[k])return GEO[k];
  }
  return null;
}
function wineColor(w){
  let c=(w.color||w.type||'').toLowerCase();
  if(c.includes('rosÃ©')||c.includes('rose'))return'#d4838f';
  if(c.includes('white'))return'#d4af37';
  if(c.includes('orange'))return'#cc7832';
  if(c.includes('red'))return'#8b2252';
  if(c.includes('sparkling'))return'#c0c0c0';
  // For unknown types, generate a consistent distinct color
  if(c){let h=0;for(let i=0;i<c.length;i++)h=((h<<5)+h+c.charCodeAt(i))|0;h=Math.abs(h);return`hsl(${h%360},55%,50%)`}
  return'#8b2252';
}
function buildPopupHtml(wineList,title){
  let html=`<b>${title}</b> â€” ${wineList.length} wine${wineList.length>1?'s':''}<br><hr>`;
  wineList.forEach(w=>{
    html+=`<div class="pw"><div class="pw-name">${w.wine} ${w.vintage||''}</div>`;
    html+=`<div class="pw-meta">${w.varietal||''} Â· ${w.type||''} Â· ${w.consumed||''}</div>`;
    if(w.note)html+=`<div class="pw-note">"${w.note}"</div>`;
    html+=`</div>`;
  });
  return html;
}

// Track exploded (spidered) marker groups
let _spiderfied=null;
let _spiderLines=[];

function collapseSpider(){
  if(!_spiderfied)return;
  _spiderfied.markers.forEach((m,i)=>{m.setLatLng(_spiderfied.center)});
  _spiderLines.forEach(l=>mapLayerGroup.removeLayer(l));
  _spiderLines=[];
  _spiderfied=null;
}

function explodeMarkers(groupKey,markers,center){
  if(_spiderfied&&_spiderfied.key===groupKey){collapseSpider();return}
  collapseSpider();
  if(markers.length<2)return;
  let count=markers.length;
  let radius=0.15*Math.pow(2,Math.max(0,6-map.getZoom())); // Scale with zoom
  _spiderfied={key:groupKey,center:center,markers:markers};
  markers.forEach((m,i)=>{
    let angle=(2*Math.PI*i/count)-(Math.PI/2);
    let lat=center[0]+radius*Math.cos(angle);
    let lng=center[1]+radius*Math.sin(angle);
    m.setLatLng([lat,lng]);
    // Draw a thin line from center to exploded position
    let line=L.polyline([center,[lat,lng]],{color:'rgba(255,255,255,.3)',weight:1,dashArray:'3,4'});
    line.addTo(mapLayerGroup);
    _spiderLines.push(line);
  });
}

function rebuildMap(data){
  mapLayerGroup.clearLayers();
  _spiderfied=null;_spiderLines=[];
  let locGroups={};
  for(let w of data){
    let coords=getCoords(w);if(!coords)continue;
    let key=coords[0]+','+coords[1];
    if(!locGroups[key])locGroups[key]={coords,wines:[]};
    locGroups[key].wines.push(w);
  }
  Object.values(locGroups).forEach(g=>{
    let byColor={};
    g.wines.forEach(w=>{let c=wineColor(w);if(!byColor[c])byColor[c]=[];byColor[c].push(w)});
    let colorEntries=Object.entries(byColor).sort((a,b)=>b[1].length-a[1].length);
    let groupMarkers=[];
    let groupKey=g.coords[0]+','+g.coords[1];
    colorEntries.forEach(([col,wines])=>{
      let size=Math.min(8+wines.length*1.5,30);
      let marker=L.circleMarker(g.coords,{radius:size,fillColor:col,color:'#fff',weight:1,opacity:.6,fillOpacity:.5});
      let w1=wines[0];
      let reg=w1.appellation!=='Unknown'?w1.appellation:w1.subRegion!=='Unknown'?w1.subRegion:w1.region;
      let title=`${reg}, ${w1.country}`;
      marker.bindPopup(buildPopupHtmlWithTerroir(wines,title,g.coords),{maxWidth:400,maxHeight:500});
      // If multiple colors at this location, first click explodes instead of opening popup
      if(colorEntries.length>1){
        marker.on('click',function(e){
          if(!_spiderfied||_spiderfied.key!==groupKey){
            e.originalEvent.stopPropagation();
            explodeMarkers(groupKey,groupMarkers,g.coords);
          }
        });
      }
      marker.addTo(mapLayerGroup);
      groupMarkers.push(marker);
    });
  });
  // Click on map background collapses spider
  map.off('click',collapseSpider);
  map.on('click',collapseSpider);
}

function matchesFilter(w,filter){
  if(!filter)return true;let f=filter.toLowerCase();
  return(w.color||'').toLowerCase().includes(f)||(w.type||'').toLowerCase().includes(f)||(w.masterVarietal||'').toLowerCase().includes(f)||(w.varietal||'').toLowerCase().includes(f);
}
function getThemeColors(){
  if(activeFilters.size===0)return{bg:'#4a5568',border:'#718096',cls:'fill-neutral'};
  let filtered=getFiltered();
  // Count by actual wineColor to find dominant
  let colorCounts={};
  filtered.forEach(w=>{let c=wineColor(w);colorCounts[c]=(colorCounts[c]||0)+1});
  let dominant=Object.entries(colorCounts).sort((a,b)=>b[1]-a[1])[0];
  if(!dominant)return{bg:'#4a5568',border:'#718096',cls:'fill-neutral'};
  return{bg:dominant[0],border:dominant[0],cls:'fill-neutral'};
}
function applyTheme(){let t=getThemeColors();document.documentElement.style.setProperty('--accent-bg',t.bg);document.documentElement.style.setProperty('--accent-border',t.border)}
function getFiltered(){
  if(activeFilters.size===0)return wines;
  return wines.filter(w=>{for(let f of activeFilters){if(matchesFilter(w,f))return true}return false});
}
function filterColorClass(f){
  // Dynamically determine button color from the wines that match this filter
  let fl=f.toLowerCase();
  if(fl==='all')return'active-neutral';
  let matched=wines.filter(w=>matchesFilter(w,f));
  if(matched.length===0)return'active-neutral';
  let colorCounts={};
  matched.forEach(w=>{let c=wineColor(w);colorCounts[c]=(colorCounts[c]||0)+1});
  let dominant=Object.entries(colorCounts).sort((a,b)=>b[1]-a[1])[0][0];
  if(dominant==='#d4af37')return'active-white';
  if(dominant==='#d4838f')return'active-rose';
  if(dominant==='#8b2252')return'active-red';
  return'active-neutral';
}
function makeBar(label,count,max,cls,onclick,inlineColor){
  let fillStyle=inlineColor?`background:${inlineColor}`:'';
  return`<div class="bar-row" style="cursor:pointer" onclick="${onclick}"><span class="bar-label" title="${label}">${label}</span><div class="bar-track"><div class="bar-fill ${cls}" style="width:${(count/max*100).toFixed(1)}%;${fillStyle}"></div></div><span class="bar-count">${count}</span></div>`;
}
function escHtml(s){return s.replace(/'/g,"\\'").replace(/"/g,'&quot;')}

function showBarPopup(wineList,title){
  let panel=document.getElementById('detail-panel');
  let html=`<button class="close-btn" onclick="hideDetail()">âœ•</button><h4>${title} â€” ${wineList.length} wine${wineList.length>1?'s':''}</h4>`;
  wineList.forEach(w=>{html+=`<div class="dp-wine"><div class="dp-name">${w.wine} ${w.vintage||''}</div><div class="dp-meta">${w.varietal||''} Â· ${w.type||''} Â· ${w.consumed||''}</div>${w.note?`<div class="dp-note">"${w.note}"</div>`:''}</div>`});
  panel.innerHTML=html;panel.style.display='block';panel.scrollIntoView({behavior:'smooth',block:'nearest'});
}
function hideDetail(){document.getElementById('detail-panel').style.display='none'}
function showCountry(c){showBarPopup(getFiltered().filter(w=>(w.country||'')==c),c)}
function showVarietal(v){showBarPopup(getFiltered().filter(w=>(w.masterVarietal||w.varietal||'')==v),v)}
function showMonth(key){showBarPopup((window._monthWines||{})[key]||[],key.replace('-','/'))}

function updateCharts(){
  let data=getFiltered();let theme=getThemeColors();
  // Country
  let countries={};data.forEach(w=>{let c=w.country||'?';countries[c]=(countries[c]||0)+1});
  let cAll=Object.entries(countries).sort((a,b)=>b[1]-a[1]);
  let cSorted=countryExpanded?cAll:cAll.slice(0,10);let cMax=cAll[0]?cAll[0][1]:1;
  let cHtml=cSorted.map(([k,v])=>{
    let cw=data.filter(w=>(w.country||'')==k);
    let cc={};cw.forEach(w=>{let c=wineColor(w);cc[c]=(cc[c]||0)+1});
    let domColor=Object.entries(cc).sort((a,b)=>b[1]-a[1])[0][0];
    return makeBar(k,v,cMax,'',`showCountry('${escHtml(k)}')`,domColor);
  }).join('');
  if(cAll.length>10)cHtml+=`<div style="text-align:center;margin-top:6px"><button style="background:none;border:none;color:#888;cursor:pointer;font-size:11px;text-decoration:underline" onclick="countryExpanded=!countryExpanded;updateCharts()">${countryExpanded?'Show top 10':'Show all ('+cAll.length+')'}</button></div>`;
  document.getElementById('c-country').innerHTML=cHtml;
  // Varietal
  let vars={};data.forEach(w=>{let v=w.masterVarietal||w.varietal||'?';vars[v]=(vars[v]||0)+1});
  let vAll=Object.entries(vars).sort((a,b)=>b[1]-a[1]);
  let vSorted=varietalExpanded?vAll:vAll.slice(0,10);let vMax=vAll[0]?vAll[0][1]:1;
  let vHtml=vSorted.map(([k,v])=>{
    let vw=data.filter(w=>(w.masterVarietal||w.varietal||'')==k);
    // Find dominant color for this varietal
    let cc={};vw.forEach(w=>{let c=wineColor(w);cc[c]=(cc[c]||0)+1});
    let domColor=Object.entries(cc).sort((a,b)=>b[1]-a[1])[0][0];
    return makeBar(k,v,vMax,'',`showVarietal('${escHtml(k)}')`,domColor);
  }).join('');
  if(vAll.length>10)vHtml+=`<div style="text-align:center;margin-top:6px"><button style="background:none;border:none;color:#888;cursor:pointer;font-size:11px;text-decoration:underline" onclick="varietalExpanded=!varietalExpanded;updateCharts()">${varietalExpanded?'Show top 10':'Show all ('+vAll.length+')'}</button></div>`;
  document.getElementById('c-varietal').innerHTML=vHtml;
  // Timeline
  let months={};let monthWines={};
  data.forEach(w=>{let y=w.consumedYear,m=w.consumedMonth;if(!y||!m)return;let key=y+'-'+(m.length<2?'0'+m:m);months[key]=(months[key]||0)+1;if(!monthWines[key])monthWines[key]=[];monthWines[key].push(w)});
  window._monthWines=monthWines;
  let mSorted=Object.entries(months).sort((a,b)=>a[0].localeCompare(b[0]));let mMax=Math.max(...mSorted.map(x=>x[1]),1);
  let bars='';let yearLabels='';let prevYear='';let totalBars=mSorted.length;
  // Count months per year to decide which labels to show
  let yearMonthCounts={};
  mSorted.forEach(([k])=>{let y=k.split('-')[0];yearMonthCounts[y]=(yearMonthCounts[y]||0)+1});
  mSorted.forEach(([k,v],i)=>{let[y,m]=k.split('-');let label=m+'/'+y.slice(2);let pct=(v/mMax*100).toFixed(1);
    // Add full-height divider line at year boundary
    if(y!==prevYear&&prevYear!==''){bars+=`<div style="width:1px;min-width:1px;background:rgba(255,255,255,.2);align-self:stretch;margin:0 1px;flex-shrink:0"></div>`}
    // Find dominant color for this month's wines
    let mWines=(monthWines[k]||[]);let mcc={};mWines.forEach(w=>{let c=wineColor(w);mcc[c]=(mcc[c]||0)+1});
    let mDomColor=Object.entries(mcc).sort((a,b)=>b[1]-a[1])[0];let barColor=mDomColor?mDomColor[0]:'#718096';
    bars+=`<div class="tl-bar" style="height:${Math.max(pct,3)}%;background:${barColor}" onclick="showMonth('${k}')"><span class="tip">${label}: ${v} wine${v>1?'s':''}</span></div>`;
    // Year label row: add spacer for divider, then label at first month of each year
    if(y!==prevYear&&prevYear!==''){yearLabels+=`<span style="width:1px;min-width:1px;flex:0 0 1px;margin:0 1px"></span>`}
    if(y!==prevYear){
      // Only show label if this year has enough months to fit the text (3+), or it's the last year
      let showLabel=yearMonthCounts[y]>=3||i>=totalBars-3;
      yearLabels+=`<span style="color:rgba(255,255,255,.45)">${showLabel?y:''}</span>`;
    }else{yearLabels+=`<span></span>`}
    prevYear=y;
  });
  document.getElementById('c-timeline').innerHTML=`<div class="tl-wrapper"><div class="tl">${bars}</div><div class="tl-year-row">${yearLabels}</div></div>`;
  let filterLabel=activeFilters.size===0?'All types':[...activeFilters].join(', ');
  document.getElementById('stats').textContent=`${data.length} wines Â· ${Object.keys(countries).length} countries Â· ${filterLabel}`;
}

function updateAll(){let filtered=getFiltered();rebuildMap(filtered);if(splitActive)rebuildMap2(filtered);updateCharts()}

// ===== OVERLAYS =====
function syncOverlayToMap2(name,visible){
  if(!map2)return;
  if(visible){if(!map2Layers[name])map2Layers[name]=createMap2Layer(name);if(map2Layers[name])map2Layers[name].addTo(map2)}
  else{if(map2Layers[name]){map2.removeLayer(map2Layers[name]);delete map2Layers[name]}}
}
function createMap2Layer(name){
  let layers={
    'climate':()=>L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}',{opacity:0.5,maxZoom:8}),
    'elev':()=>L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{opacity:0.55,maxZoom:17}),
    'sat':()=>L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{opacity:0.7,maxZoom:19}),
    'soil':()=>L.tileLayer.wms('https://maps.isric.org/mapserv?map=/map/wrb.map',{layers:'MostProbable',format:'image/png',transparent:true,opacity:0.5}),
    'geo':()=>L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png',{opacity:0.45,maxZoom:18}),
    'crop':()=>L.tileLayer.wms('https://image.discomap.eea.europa.eu/arcgis/services/Corine/CLC2018_WM/MapServer/WMSServer',{layers:'12',format:'image/png',transparent:true,opacity:0.55,maxZoom:18}),
  };
  return layers[name]?layers[name]():null;
}
function syncAllOverlaysToMap2(){
  if(!map2)return;
  [['climate',climateVisible],['elev',elevVisible],['sat',satVisible],['soil',soilVisible],['geo',geoVisible],['crop',cropVisible]].forEach(([n,v])=>{
    if(v&&!map2Layers[n]){map2Layers[n]=createMap2Layer(n);if(map2Layers[n])map2Layers[n].addTo(map2)}
  });
}
function toggleClimate(){climateVisible=!climateVisible;let b=document.getElementById('climate-toggle');if(climateVisible){climateLayer.addTo(map);b.classList.add('active')}else{map.removeLayer(climateLayer);b.classList.remove('active')}document.getElementById('climate-legend').style.display=climateVisible?'block':'none';repositionLegends();syncOverlayToMap2('climate',climateVisible)}
function toggleElevation(){elevVisible=!elevVisible;let b=document.getElementById('elev-toggle');if(elevVisible){elevLayer.addTo(map);b.classList.add('active')}else{map.removeLayer(elevLayer);b.classList.remove('active')}document.getElementById('elev-legend').style.display=elevVisible?'block':'none';repositionLegends();syncOverlayToMap2('elev',elevVisible)}
function toggleSatellite(){satVisible=!satVisible;let b=document.getElementById('sat-toggle');if(satVisible){satLayer.addTo(map);b.classList.add('active')}else{map.removeLayer(satLayer);b.classList.remove('active')}syncOverlayToMap2('sat',satVisible)}
function toggleSoil(){soilVisible=!soilVisible;let b=document.getElementById('soil-toggle');if(soilVisible){soilLayer.addTo(map);b.classList.add('active')}else{map.removeLayer(soilLayer);b.classList.remove('active')}document.getElementById('soil-legend').style.display=soilVisible?'block':'none';repositionLegends();syncOverlayToMap2('soil',soilVisible)}
function toggleGeology(){geoVisible=!geoVisible;let b=document.getElementById('geo-toggle');if(geoVisible){geoLayer.addTo(map);b.classList.add('active')}else{map.removeLayer(geoLayer);b.classList.remove('active')}syncOverlayToMap2('geo',geoVisible)}

// Stack visible legends vertically so they don't overlap
function repositionLegends(){
  requestAnimationFrame(()=>{
    let ids=['climate-legend','elev-legend','soil-legend','crop-legend'];
    let offset=10;
    ids.forEach(id=>{
      let el=document.getElementById(id);
      if(el&&el.style.display!=='none'){
        el.style.top=offset+'px';el.style.bottom='auto';el.style.left='10px';
        offset+=el.offsetHeight+8;
      }
    });
  });
}

// Cropland overlay (CORINE Land Cover â€” vineyards & cropland, Europe via EEA WMS)
let cropLayer=L.tileLayer.wms('https://image.discomap.eea.europa.eu/arcgis/services/Corine/CLC2018_WM/MapServer/WMSServer',{
  layers:'12',format:'image/png',transparent:true,opacity:0.55,attribution:'CORINE Land Cover 2018 Â© EEA',maxZoom:18
});
let cropVisible=false;
function toggleCropland(){
  cropVisible=!cropVisible;let btn=document.getElementById('crop-toggle');
  if(cropVisible){cropLayer.addTo(map);btn.classList.add('active')}
  else{map.removeLayer(cropLayer);btn.classList.remove('active')}
  document.getElementById('crop-legend').style.display=cropVisible?'block':'none';
  repositionLegends();
  syncOverlayToMap2('crop',cropVisible);
}

// ===== REGIONS =====
const REGIONS=[
{name:"Napa Valley",lat:38.50,lng:-122.27,zoom:8},{name:"Sonoma",lat:38.52,lng:-122.81,zoom:8},
{name:"Paso Robles",lat:35.63,lng:-120.69,zoom:9},{name:"Santa Barbara",lat:34.71,lng:-119.99,zoom:9},
{name:"Willamette Valley",lat:45.07,lng:-123.07,zoom:8},{name:"Columbia Valley",lat:46.5,lng:-119.5,zoom:8},
{name:"Burgundy",lat:47.04,lng:4.84,zoom:7},{name:"Bordeaux",lat:44.84,lng:-0.58,zoom:8},
{name:"Champagne",lat:49.25,lng:3.96,zoom:8},{name:"RhÃ´ne Valley",lat:44.50,lng:4.81,zoom:7},
{name:"Loire Valley",lat:47.38,lng:0.69,zoom:7},{name:"Alsace",lat:48.20,lng:7.35,zoom:8},
{name:"Languedoc",lat:43.61,lng:3.88,zoom:8},{name:"Provence",lat:43.50,lng:6.20,zoom:8},
{name:"Mosel",lat:49.73,lng:6.63,zoom:8},{name:"Rheingau",lat:50.02,lng:8.05,zoom:9},
{name:"Pfalz",lat:49.35,lng:8.15,zoom:9},
{name:"Piedmont",lat:44.69,lng:8.04,zoom:8},{name:"Tuscany",lat:43.35,lng:11.32,zoom:8},
{name:"Veneto",lat:45.44,lng:10.99,zoom:8},{name:"Sicily",lat:37.60,lng:14.27,zoom:8},
{name:"Rioja",lat:42.47,lng:-2.45,zoom:8},{name:"Ribera del Duero",lat:41.65,lng:-3.70,zoom:9},
{name:"Priorat",lat:41.20,lng:0.85,zoom:9},
{name:"Douro",lat:41.16,lng:-7.79,zoom:8},{name:"Alentejo",lat:38.57,lng:-7.91,zoom:8},
{name:"Barossa",lat:-34.56,lng:138.95,zoom:9},{name:"McLaren Vale",lat:-35.22,lng:138.55,zoom:9},
{name:"Margaret River",lat:-33.95,lng:115.08,zoom:9},{name:"Hunter Valley",lat:-32.75,lng:151.15,zoom:9},
{name:"Marlborough",lat:-41.52,lng:173.95,zoom:9},{name:"Central Otago",lat:-45.03,lng:169.20,zoom:9},
{name:"Mendoza",lat:-32.89,lng:-68.83,zoom:8},{name:"Casablanca",lat:-33.32,lng:-71.41,zoom:9},
{name:"Stellenbosch",lat:-33.93,lng:18.86,zoom:9},{name:"Swartland",lat:-33.45,lng:18.75,zoom:9},
];

function buildRegionLayer(){
  let lg=L.layerGroup();
  REGIONS.forEach(r=>{let l=L.marker([r.lat,r.lng],{icon:L.divIcon({className:'region-label',html:r.name,iconSize:[null,null]})});l._minZoom=r.zoom;lg.addLayer(l)});
  return lg;
}
function toggleRegions(){
  regionsVisible=!regionsVisible;let b=document.getElementById('region-toggle');
  if(regionsVisible){regionLayer.addTo(map);b.classList.add('active');updateRegionVis(map,regionLayer);
    if(map2){if(!regionLayer2)regionLayer2=buildRegionLayer();regionLayer2.addTo(map2);map2.off('zoomend',()=>updateRegionVis(map2,regionLayer2));map2.on('zoomend',()=>updateRegionVis(map2,regionLayer2));setTimeout(()=>updateRegionVis(map2,regionLayer2),200)}
  }else{map.removeLayer(regionLayer);b.classList.remove('active');if(map2&&regionLayer2){map2.removeLayer(regionLayer2);regionLayer2=null}}
}
function updateRegionVis(m,layer){if(!regionsVisible||!layer)return;let z=m.getZoom();layer.eachLayer(l=>{let el=l.getElement&&l.getElement();if(!el)return;el.style.opacity=z>=(l._minZoom-1)?'1':'0'})}

// ===== SPLIT VIEW =====
function rebuildMap2(data){
  if(!map2)return;map2.eachLayer(l=>{if(l instanceof L.CircleMarker)map2.removeLayer(l)});
  let locGroups={};
  for(let w of data){let coords=getCoords(w);if(!coords)continue;let key=coords[0]+','+coords[1];if(!locGroups[key])locGroups[key]={coords,wines:[]};locGroups[key].wines.push(w)}
  Object.values(locGroups).forEach(g=>{
    let byColor={};g.wines.forEach(w=>{let c=wineColor(w);if(!byColor[c])byColor[c]=[];byColor[c].push(w)});
    let colorEntries=Object.entries(byColor).sort((a,b)=>b[1].length-a[1].length);
    colorEntries.forEach(([col,wines])=>{
      let size=Math.min(8+wines.length*1.5,30);
      let marker=L.circleMarker(g.coords,{radius:size,fillColor:col,color:'#fff',weight:1,opacity:.6,fillOpacity:.5});
      let w1=wines[0];let region=w1.appellation!=='Unknown'?w1.appellation:w1.subRegion!=='Unknown'?w1.subRegion:w1.region;
      marker.bindPopup(buildPopupHtmlWithTerroir(wines,`${region}, ${w1.country}`,g.coords),{maxWidth:400,maxHeight:500});marker.addTo(map2);
    });
  });
}
function toggleSplit(){
  splitActive=!splitActive;let b=document.getElementById('split-toggle');let wrapper=document.getElementById('map-wrapper');
  let mapDiv=document.getElementById('map');let map2Div=document.getElementById('map2');
  if(splitActive){
    b.classList.add('active');wrapper.classList.add('split-active');
    if(!wrapper.classList.contains('fullscreen')){mapDiv.style.width='50%';mapDiv.style.display='inline-block';map2Div.style.display='inline-block';map2Div.style.width='50%';map2Div.style.height='50vh';map2Div.style.verticalAlign='top';mapDiv.style.verticalAlign='top'}
    setTimeout(()=>{map.invalidateSize();if(!map2){map2=L.map('map2',{scrollWheelZoom:true}).setView([46,2],5);L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map2);rebuildMap2(getFiltered());syncAllOverlaysToMap2();setupMapClickHandler(map2);
      if(regionsVisible){if(!regionLayer2)regionLayer2=buildRegionLayer();regionLayer2.addTo(map2);map2.on('zoomend',()=>updateRegionVis(map2,regionLayer2));setTimeout(()=>updateRegionVis(map2,regionLayer2),200)}
    }else map2.invalidateSize()},150);
  }else{
    b.classList.remove('active');wrapper.classList.remove('split-active');
    if(!wrapper.classList.contains('fullscreen')){mapDiv.style.width='100%';mapDiv.style.display='block';map2Div.style.display='none'}else{map2Div.style.display='none';mapDiv.style.width='';mapDiv.style.display=''}
    if(map2){map2.remove();map2=null;map2Layers={};regionLayer2=null}setTimeout(()=>map.invalidateSize(),100);
  }
}
function toggleFullscreen(){
  let el=document.getElementById('map-wrapper');let b=document.getElementById('fs-btn');
  if(el.classList.contains('fullscreen')){el.classList.remove('fullscreen');b.textContent='â›¶';
    if(splitActive){let md=document.getElementById('map');let m2=document.getElementById('map2');md.style.width='50%';md.style.display='inline-block';md.style.verticalAlign='top';m2.style.display='inline-block';m2.style.width='50%';m2.style.height='50vh';m2.style.verticalAlign='top'}
  }else{el.classList.add('fullscreen');b.textContent='âœ•';syncAllFsOverlayButtons()}
  setTimeout(()=>{map.invalidateSize();if(map2)map2.invalidateSize()},150);
}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){let el=document.getElementById('map-wrapper');if(el.classList.contains('fullscreen'))toggleFullscreen()}});

// ===== SEARCH =====
let searchTerm='',_searchTimer=null;
function doSearch(val){
  searchTerm=val.trim().toLowerCase();document.getElementById('search-clear').style.display=searchTerm?'block':'none';
  clearTimeout(_searchTimer);_searchTimer=setTimeout(()=>{
    if(searchTerm){
      let results=wines.filter(w=>(w.wine||'').toLowerCase().includes(searchTerm)||(w.varietal||'').toLowerCase().includes(searchTerm)||(w.country||'').toLowerCase().includes(searchTerm)||(w.region||'').toLowerCase().includes(searchTerm)||(w.appellation||'').toLowerCase().includes(searchTerm)||(w.note||'').toLowerCase().includes(searchTerm)||(w.vintage||'').includes(searchTerm));
      rebuildMap(results);
      if(splitActive)rebuildMap2(results);
      let panel=document.getElementById('detail-panel');
      let html=`<button class="close-btn" onclick="hideDetail()">âœ•</button><h4>Search: "${val.trim()}" â€” ${results.length} result${results.length!==1?'s':''}</h4>`;
      results.forEach(w=>{html+=`<div class="dp-wine"><div class="dp-name">${w.wine} ${w.vintage||''}</div><div class="dp-meta">${w.varietal||''} Â· ${w.type||''} Â· ${w.consumed||''}</div>${w.note?`<div class="dp-note">"${w.note}"</div>`:''}</div>`});
      panel.innerHTML=html;panel.style.display='block';
    }else{updateAll();hideDetail()}
  },300);
}
function clearSearch(){document.getElementById('wine-search').value='';doSearch('')}

// ===== FULLSCREEN CONTROLS =====
function toggleFsControls(){
  let body=document.getElementById('fs-ctrl-body');let btn=document.getElementById('fs-ctrl-toggle');
  if(body.style.display==='none'){body.style.display='flex';btn.textContent='â–¼ Controls'}else{body.style.display='none';btn.textContent='â–¶ Controls'}
}
function fsFilter(f){
  if(activeFilters.has(f))activeFilters.delete(f);else activeFilters.add(f);
  if(window._buildFilters)window._buildFilters();applyTheme();updateAll();
}
function syncFsBtn(el,mainId){let mainBtn=document.getElementById(mainId);el.classList.toggle('active',mainBtn.classList.contains('active'))}
function syncAllFsOverlayButtons(){
  let fsButtons=document.querySelectorAll('#fs-ctrl-body .region-toggle');
  let mainButtons=document.querySelectorAll('.search-bar .region-toggle');
  mainButtons.forEach(mainBtn=>{fsButtons.forEach(fsBtn=>{if(fsBtn.textContent.trim()===mainBtn.textContent.trim())fsBtn.classList.toggle('active',mainBtn.classList.contains('active'))})});
}

// ===== GEO/SOIL CLICK HANDLER =====
function hideGeoInfo(){document.getElementById('geo-info').style.display='none'}

const SOIL_WINE_INFO={
  'Acrisols':'Acidic weathered tropical clay. Poor for viticulture.',
  'Albeluvisols':'Bleached clay subsoil. Limited wine use.',
  'Alisols':'Acidic clay â€” challenging, requires careful management.',
  'Andosols':'Volcanic ash â€” good drainage, mineral character. Found in Etna, Canary Islands.',
  'Arenosols':'Sandy â€” good drainage, low fertility. Produces elegant, aromatic wines.',
  'Calcisols':'Limestone/chalk â€” classic terroir for Champagne, Burgundy, Loire. Excellent drainage, mineral character.',
  'Cambisols':'Versatile, well-balanced drainage and nutrients. Found across many quality wine regions.',
  'Chernozems':'Black humus-rich steppe â€” very fertile. Can produce vigorous vines.',
  'Cryosols':'Permafrost soils. Not used for viticulture.',
  'Durisols':'Cemented hardpan soils. Challenging for root penetration.',
  'Ferralsols':'Iron-rich tropical soils. Rarely used for wine.',
  'Fluvisols':'River/alluvial â€” rich and fertile. Best when gravel content is high.',
  'Gleysols':'Waterlogged soils. Poor drainage limits vine health.',
  'Gypsisols':'Gypsum-rich desert soils. Rarely used for wine.',
  'Histosols':'Organic/peat soils. Too wet for viticulture.',
  'Kastanozems':'Chestnut steppe soils. Moderate fertility, balanced vine growth.',
  'Leptosols':'Thin rocky soils over bedrock. Vines root deep â€” concentrated, mineral-driven wines.',
  'Lixisols':'Tropical clay with good base saturation. Limited wine use.',
  'Luvisols':'Clay-rich subsoil with good drainage. Retains moisture â€” excellent for structured reds.',
  'Nitisols':'Deep, red, well-drained tropical soils. Some potential in warm climates.',
  'Phaeozems':'Dark, humus-rich prairie soils. Fertile â€” can produce vigorous vines.',
  'Planosols':'Abrupt clay increase causing waterlogging. Challenging for vines.',
  'Plinthosols':'Iron/clay crust soils. Not typically used for wine.',
  'Podzols':'Leached, acidic forest soils. Poor for viticulture.',
  'Regosols':'Unconsolidated mineral soils. Variable for wine depending on parent material.',
  'Solonchaks':'Saline soils. Too salty for most vines.',
  'Solonetz':'Sodic (high sodium) soils. Challenging for agriculture.',
  'Stagnosols':'Periodically waterlogged. Poor drainage limits vine health.',
  'Umbrisols':'Dark, acidic humus-rich soils. Limited wine potential.',
  'Vertisols':'Heavy swelling clay. Challenging drainage but powerful wines in warm climates.',
};

// CORINE Land Cover class definitions (official EEA colors and names)
const CORINE_CLASSES={
  1:{name:'Continuous urban fabric',color:'#e6004d'},
  2:{name:'Discontinuous urban fabric',color:'#ff0000'},
  3:{name:'Industrial or commercial units',color:'#cc4df2'},
  4:{name:'Road and rail networks',color:'#cc0000'},
  5:{name:'Port areas',color:'#e6cccc'},
  6:{name:'Airports',color:'#e6cce6'},
  7:{name:'Mineral extraction sites',color:'#a600cc'},
  8:{name:'Dump sites',color:'#a64d00'},
  9:{name:'Construction sites',color:'#ff4dff'},
  10:{name:'Green urban areas',color:'#ffa6ff'},
  11:{name:'Sport and leisure facilities',color:'#ffe6ff'},
  12:{name:'Non-irrigated arable land',color:'#ffffa8'},
  13:{name:'Permanently irrigated land',color:'#ffff00'},
  14:{name:'Rice fields',color:'#e6e600'},
  15:{name:'Vineyards',color:'#e68000',wine:'Vineyard land â€” the key indicator for wine-producing terroir.'},
  16:{name:'Fruit trees and berry plantations',color:'#f2a64d'},
  17:{name:'Olive groves',color:'#e6a600'},
  18:{name:'Pastures',color:'#e6e64d'},
  19:{name:'Annual crops with permanent crops',color:'#ffe6a6'},
  20:{name:'Complex cultivation patterns',color:'#ffe64d'},
  21:{name:'Agriculture with natural vegetation',color:'#e6cc4d'},
  22:{name:'Agro-forestry areas',color:'#f2cca6'},
  23:{name:'Broad-leaved forest',color:'#80ff00'},
  24:{name:'Coniferous forest',color:'#00a600'},
  25:{name:'Mixed forest',color:'#4dff00'},
  26:{name:'Natural grasslands',color:'#ccf24d'},
  27:{name:'Moors and heathland',color:'#a6ff80'},
  28:{name:'Sclerophyllous vegetation',color:'#a6e64d'},
  29:{name:'Transitional woodland-shrub',color:'#a6f200'},
  30:{name:'Beaches, dunes, sands',color:'#e6e6e6'},
  31:{name:'Bare rocks',color:'#cccccc'},
  32:{name:'Sparsely vegetated areas',color:'#ccffcc'},
  33:{name:'Burnt areas',color:'#000000'},
  34:{name:'Glaciers and perpetual snow',color:'#a6e6cc'},
  35:{name:'Inland marshes',color:'#a6a6ff'},
  36:{name:'Peat bogs',color:'#4d4dff'},
  37:{name:'Salt marshes',color:'#ccccff'},
  38:{name:'Salines',color:'#e6e6ff'},
  39:{name:'Intertidal flats',color:'#a6a6e6'},
  40:{name:'Water courses',color:'#00ccf2'},
  41:{name:'Water bodies',color:'#80f2e6'},
  42:{name:'Coastal lagoons',color:'#00ffa6'},
  43:{name:'Estuaries',color:'#a6ffe6'},
  44:{name:'Sea and ocean',color:'#e6f2ff'},
};

function setupMapClickHandler(targetMap){
  targetMap.on('click',async function(e){
    if(!geoVisible&&!soilVisible&&!cropVisible)return;
    let lat=e.latlng.lat.toFixed(4),lng=e.latlng.lng.toFixed(4);
    let panel=document.getElementById('geo-info'),content=document.getElementById('geo-content');
    content.innerHTML='<i>Loading...</i>';panel.style.display='block';
    let sections=[];
    if(geoVisible){
      try{
        let resp=await fetch(`https://macrostrat.org/api/geologic_units/map?lat=${lat}&lng=${lng}&response=long`);
        let data=await resp.json();
        if(data.success&&data.success.data&&data.success.data.length>0){
          let u=data.success.data[0];
          // Use API-provided color
          let colorSwatch=u.color?`<span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${u.color};border:1px solid rgba(255,255,255,.3);vertical-align:middle;margin-right:6px"></span>`:'';
          // Period and age interval names from API
          let periodLabel='';
          if(u.t_int_name&&u.b_int_name&&u.t_int_name!==u.b_int_name){
            periodLabel=`${u.b_int_name} â€“ ${u.t_int_name}`;
          }else{
            periodLabel=u.t_int_name||u.b_int_name||u.best_int_name||'';
          }
          // Clean up lithology â€” strip Major:{} wrapper
          let lith=u.lith||'Unknown';
          lith=lith.replace(/Major:\{([^}]+)\}/,'$1').replace(/Minor:\{([^}]+)\}/,'(minor: $1)').replace(/\{|\}/g,'');
          let html=`<h5>${colorSwatch}${u.strat_name||u.name||'Unknown Formation'}</h5>`;
          if(periodLabel)html+=`<b>Period:</b> ${periodLabel}<br>`;
          html+=`<b>Age:</b> ${u.t_age||'?'} â€“ ${u.b_age||'?'} Ma<br>`;
          html+=`<b>Lithology:</b> ${lith}<br>`;
          if(u.descrip)html+=`<b>Description:</b> ${u.descrip}<br>`;
          // Link to Macrostrat for full details
          html+=`<div style="margin-top:4px"><a href="https://macrostrat.org/map/loc/${lng}/${lat}#z=${targetMap.getZoom()}" target="_blank" style="color:#d4af37;font-size:10px;text-decoration:none;border-bottom:1px solid rgba(212,175,55,.3)">View on Macrostrat â†’</a></div>`;
          sections.push(html);
        }else sections.push('<h5>No geology data</h5>');
      }catch(err){sections.push(`<h5>Geology error</h5><span style="color:#888">${err.message}</span>`)}
    }
    if(soilVisible){
      try{
        let bounds=targetMap.getBounds(),size=targetMap.getSize(),point=targetMap.latLngToContainerPoint(e.latlng);
        let bbox=`${bounds.getSouthWest().lng},${bounds.getSouthWest().lat},${bounds.getNorthEast().lng},${bounds.getNorthEast().lat}`;
        let url=`https://maps.isric.org/mapserv?map=/map/wrb.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=MostProbable&QUERY_LAYERS=MostProbable&STYLES=default&INFO_FORMAT=application/geo%2Bjson&SRS=EPSG:4326&BBOX=${bbox}&WIDTH=${size.x}&HEIGHT=${size.y}&X=${Math.round(point.x)}&Y=${Math.round(point.y)}`;
        let resp=await fetch(url);let data=await resp.json();
        if(data.features&&data.features.length>0){
          let soilClass=data.features[0].properties.pixel_value||'Unknown';
          let wineInfo=SOIL_WINE_INFO[soilClass]||'';
          let html=`<h5>ðŸŒ± Soil: ${soilClass}</h5>`;
          if(wineInfo)html+=`<div style="margin:4px 0;padding:4px 8px;background:rgba(139,105,20,.15);border-left:2px solid #8b6914;font-size:11px;color:#d4af37">${wineInfo}</div>`;
          sections.push(html);
        }else sections.push('<h5>ðŸŒ± No soil data</h5>');
      }catch(err){sections.push(`<h5>ðŸŒ± Soil error</h5><span style="color:#888">${err.message}</span>`)}
    }
    if(cropVisible){
      try{
        let bounds=targetMap.getBounds(),size=targetMap.getSize(),point=targetMap.latLngToContainerPoint(e.latlng);
        let bbox=`${bounds.getSouthWest().lng},${bounds.getSouthWest().lat},${bounds.getNorthEast().lng},${bounds.getNorthEast().lat}`;
        let url=`https://image.discomap.eea.europa.eu/arcgis/services/Corine/CLC2018_WM/MapServer/WMSServer?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=12&QUERY_LAYERS=12&INFO_FORMAT=text/xml&SRS=EPSG:4326&BBOX=${bbox}&WIDTH=${size.x}&HEIGHT=${size.y}&X=${Math.round(point.x)}&Y=${Math.round(point.y)}`;
        let resp=await fetch(url);let text=await resp.text();
        // Parse XML response â€” look for FIELDS element attributes
        let valueMatch=text.match(/Raster\.Value="(\d+)"/);
        let labelMatch=text.match(/Raster\.LABEL3="([^"]+)"/);
        let codeMatch=text.match(/Raster\.CODE_18="(\d+)"/);
        if(valueMatch){
          let clcIdx=parseInt(valueMatch[1]);
          let label=labelMatch?labelMatch[1]:(CORINE_CLASSES[clcIdx]?CORINE_CLASSES[clcIdx].name:'Unknown');
          let clcCode=codeMatch?codeMatch[1]:'';
          let cls=CORINE_CLASSES[clcIdx];
          let colorSwatch=cls?`<span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${cls.color};border:1px solid rgba(255,255,255,.3);vertical-align:middle;margin-right:6px"></span>`:'';
          let html=`<h5>${colorSwatch}Land Cover: ${label}</h5>`;
          if(clcCode)html+=`<span style="color:#888;font-size:10px">CLC code: ${clcCode}</span><br>`;
          if(cls&&cls.wine)html+=`<div style="margin:4px 0;padding:4px 8px;background:rgba(139,105,20,.15);border-left:2px solid #8b6914;font-size:11px;color:#d4af37">${cls.wine}</div>`;
          sections.push(html);
        }
      }catch(err){/* CORINE query failed silently */}
    }
    content.innerHTML=sections.join('<hr style="border-color:#444;margin:6px 0">')+`<br><span style="color:#888;font-size:11px">${lat}, ${lng}</span>`;
  });
}

// ===== LIVE TERROIR FETCH =====
// Fetches geology + soil for a location on demand (for popup terroir section)
let terroirCache={};
async function fetchTerroir(lat,lng){
  let key=`${lat.toFixed(2)},${lng.toFixed(2)}`;
  if(terroirCache[key])return terroirCache[key];
  let parts=[];
  try{
    let resp=await fetch(`https://macrostrat.org/api/geologic_units/map?lat=${lat}&lng=${lng}&response=long`);
    let data=await resp.json();
    if(data.success&&data.success.data&&data.success.data.length>0){
      let u=data.success.data[0];let lith=u.lith||u.liths||'Unknown';
      if(lith.length>60){let m=lith.match(/Major:\{([^}]+)\}/);if(m)lith=m[1];else lith=lith.substring(0,57)+'...'}
      parts.push(`Bedrock: ${lith}${u.t_period?' ('+u.t_period+')':''}.`);
    }
  }catch(e){}
  try{
    let d=0.5,bbox=`${lng-d},${lat-d},${lng+d},${lat+d}`;
    let url=`https://maps.isric.org/mapserv?map=/map/wrb.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&LAYERS=MostProbable&QUERY_LAYERS=MostProbable&STYLES=default&INFO_FORMAT=application/geo%2Bjson&SRS=EPSG:4326&BBOX=${bbox}&WIDTH=256&HEIGHT=256&X=128&Y=128`;
    let resp=await fetch(url);let data=await resp.json();
    if(data.features&&data.features.length>0){
      let soil=data.features[0].properties.pixel_value||'';
      let desc=SOIL_WINE_INFO[soil]||'';
      if(soil)parts.push(`Soil: ${soil}${desc?' â€” '+desc:''}`);
    }
  }catch(e){}
  let result=parts.length>0?parts.join(' '):null;
  terroirCache[key]=result;
  return result;
}

// Enhanced popup that fetches terroir on open
function buildPopupHtmlWithTerroir(wineList,title,coords){
  let id='terroir-'+Math.random().toString(36).substr(2,6);
  let html=`<b>${title}</b> â€” ${wineList.length} wine${wineList.length>1?'s':''}<br>`;
  html+=`<div id="${id}" style="margin:4px 0 8px;padding:5px 8px;background:#f5f0e0;border-left:3px solid #8b6914;font-size:11px;color:#555;line-height:1.4;display:none"><b style="color:#6b4f1d">ðŸŒ Terroir</b><br><i>Loading...</i></div>`;
  html+=`<hr>`;
  wineList.forEach(w=>{
    html+=`<div class="pw"><div class="pw-name">${w.wine} ${w.vintage||''}</div>`;
    html+=`<div class="pw-meta">${w.varietal||''} Â· ${w.type||''} Â· ${w.consumed||''}</div>`;
    if(w.note)html+=`<div class="pw-note">"${w.note}"</div>`;
    html+=`</div>`;
  });
  // Trigger async terroir fetch
  if(coords){
    setTimeout(async()=>{
      let el=document.getElementById(id);if(!el)return;
      let terroir=await fetchTerroir(coords[0],coords[1]);
      if(terroir){el.innerHTML=`<b style="color:#6b4f1d">ðŸŒ Terroir</b><br>${terroir}`;el.style.display='block'}
      else el.remove();
    },100);
  }
  return html;
}

// ===== INIT =====
function initApp(){
  // Init map
  if(map)map.remove();
  map=L.map('map',{scrollWheelZoom:true}).setView([30,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'Â©OpenStreetMap Â©CARTO',maxZoom:18}).addTo(map);
  mapLayerGroup=L.layerGroup().addTo(map);
  // Overlay layers
  climateLayer=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}',{opacity:0.5,maxZoom:8});
  elevLayer=L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{opacity:0.55,maxZoom:17});
  satLayer=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{opacity:0.7,maxZoom:19});
  soilLayer=L.tileLayer.wms('https://maps.isric.org/mapserv?map=/map/wrb.map',{layers:'MostProbable',format:'image/png',transparent:true,opacity:0.5});
  geoLayer=L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png',{opacity:0.45,maxZoom:18});
  regionLayer=buildRegionLayer();
  map.on('zoomend',()=>updateRegionVis(map,regionLayer));
  setupMapClickHandler(map);
  // Build filters â€” dynamically detect all wine types/colors and varietals
  let typeCounts={};wines.forEach(w=>{let t=(w.color||w.type||'').trim();if(t&&t!=='Unknown'&&t!=='?'){
    // Normalize: capitalize first letter
    let norm=t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();
    typeCounts[norm]=(typeCounts[norm]||0)+1;
  }});
  let typeFilters=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
  let varCounts={};wines.forEach(w=>{let v=w.masterVarietal||w.varietal;if(v&&v!=='Unknown'&&v!=='?')varCounts[v]=(varCounts[v]||0)+1});
  let allVarietals=Object.entries(varCounts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
  let topVarietals=allVarietals.slice(0,7);let extraVarietals=allVarietals.slice(7);let filtersExpanded=false;
  window._buildFilters=function(){
    let filterDiv=document.getElementById('filters');filterDiv.innerHTML='';
    let items=['All',...typeFilters,...(filtersExpanded?[...allVarietals].sort((a,b)=>a.localeCompare(b)):topVarietals)];
    items.forEach(f=>{
      let btn=document.createElement('button');let isActive=f==='All'?activeFilters.size===0:activeFilters.has(f);
      btn.className='fbtn'+(isActive?' active '+filterColorClass(f):'');btn.textContent=f;
      btn.onclick=()=>{if(f==='All')activeFilters.clear();else{if(activeFilters.has(f))activeFilters.delete(f);else activeFilters.add(f)}window._buildFilters();applyTheme();updateAll()};
      filterDiv.appendChild(btn);
    });
    if(extraVarietals.length>0){let t=document.createElement('button');t.className='fbtn';t.style.cssText='border-style:dashed;color:#888';t.textContent=filtersExpanded?'Less â–´':'More â–¾';t.onclick=()=>{filtersExpanded=!filtersExpanded;window._buildFilters()};filterDiv.appendChild(t)}
  };
  window._buildFilters();
  applyTheme();
  // Render charts immediately (no geocoding needed)
  updateCharts();
  // Start geocoding in background, rebuild map progressively
  geocodeAllWines(wines).then(()=>{rebuildMap(getFiltered())});
}

// ===== OVERLAY LEGENDS =====
// Geology legend
// Climate legend
let climateLegendHtml=`
<div style="position:absolute;top:10px;left:10px;z-index:10000;background:rgba(22,33,62,.9);border:1px solid #555;border-radius:6px;padding:8px 12px;font-size:11px;color:#ccc;display:none;line-height:1.8;max-width:220px" id="climate-legend">
<b style="color:#d4af37">Physical / Climate Key</b><br>
<span style="color:#2d6a2d">â– </span> Dense vegetation / humid<br>
<span style="color:#8fbc8f">â– </span> Moderate vegetation<br>
<span style="color:#c2b280">â– </span> Semi-arid / Mediterranean<br>
<span style="color:#d2b48c">â– </span> Arid / dry<br>
<span style="color:#f5f5dc">â– </span> Desert / very dry<br>
<span style="color:#87ceeb">â– </span> Water bodies<br>
<span style="color:#fff">â– </span> Ice / snow<br>
<i style="font-size:10px;color:#888">Green = more rainfall & warmth<br>Brown/tan = drier & hotter</i>
</div>`;
document.querySelector('#map').parentElement.insertAdjacentHTML('beforeend',climateLegendHtml);

// Elevation legend
let elevLegendHtml=`
<div style="position:absolute;top:10px;left:10px;z-index:10000;background:rgba(22,33,62,.9);border:1px solid #555;border-radius:6px;padding:8px 12px;font-size:11px;color:#ccc;display:none;line-height:1.8" id="elev-legend">
<b style="color:#d4af37">Elevation Key</b><br>
<span style="color:#2d8a2d">â– </span> Low elevation / valleys<br>
<span style="color:#a0c878">â– </span> Foothills (200â€“500m)<br>
<span style="color:#d4a574">â– </span> Mid-altitude (500â€“1000m)<br>
<span style="color:#8b6914">â– </span> High altitude (1000â€“2000m)<br>
<span style="color:#fff">â– </span> Alpine / snow (>2000m)<br>
<i style="font-size:10px;color:#888">Contour lines show elevation detail</i>
</div>`;
document.querySelector('#map').parentElement.insertAdjacentHTML('beforeend',elevLegendHtml);

// Soil legend
let soilLegendHtml=`
<div style="position:absolute;top:10px;left:10px;z-index:10000;background:rgba(22,33,62,.9);border:1px solid #555;border-radius:6px;padding:8px 12px;font-size:11px;color:#ccc;display:none;line-height:1.8;max-width:240px;max-height:350px;overflow-y:auto" id="soil-legend">
<b style="color:#d4af37">Soil Types (WRB)</b><br>
<i style="font-size:10px;color:#aaa">ISRIC SoilGrids â€” click map to identify</i><br>
<span style="color:rgb(247,153,29)">â– </span> Acrisols (weathered tropical)<br>
<span style="color:rgb(155,157,87)">â– </span> Albeluvisols (bleached clay)<br>
<span style="color:rgb(250,247,192)">â– </span> Alisols (acidic clay)<br>
<span style="color:rgb(237,58,51)">â– </span> Andosols â˜… (volcanic)<br>
<span style="color:rgb(247,216,172)">â– </span> Arenosols (sandy)<br>
<span style="color:rgb(255,238,0)">â– </span> Calcisols â˜… (limestone/chalk)<br>
<span style="color:rgb(254,205,103)">â– </span> Cambisols â˜… (versatile)<br>
<span style="color:rgb(226,200,55)">â– </span> Chernozems (black earth)<br>
<span style="color:rgb(117,106,146)">â– </span> Cryosols (permafrost)<br>
<span style="color:rgb(239,230,191)">â– </span> Durisols (hardpan)<br>
<span style="color:rgb(246,135,45)">â– </span> Ferralsols (iron-rich tropical)<br>
<span style="color:rgb(1,176,239)">â– </span> Fluvisols (alluvial)<br>
<span style="color:rgb(146,145,185)">â– </span> Gleysols (waterlogged)<br>
<span style="color:rgb(251,246,165)">â– </span> Gypsisols (gypsum)<br>
<span style="color:rgb(139,137,138)">â– </span> Histosols (organic/peat)<br>
<span style="color:rgb(201,149,128)">â– </span> Kastanozems (chestnut)<br>
<span style="color:rgb(213,214,216)">â– </span> Leptosols â˜… (thin rocky)<br>
<span style="color:rgb(249,189,191)">â– </span> Lixisols (tropical clay)<br>
<span style="color:rgb(244,131,133)">â– </span> Luvisols â˜… (clay-rich)<br>
<span style="color:rgb(247,160,130)">â– </span> Nitisols (deep red tropical)<br>
<span style="color:rgb(186,104,80)">â– </span> Phaeozems (humus-rich)<br>
<span style="color:rgb(245,147,84)">â– </span> Planosols (clay waterlogging)<br>
<span style="color:rgb(111,14,65)">â– </span> Plinthosols (iron/clay crust)<br>
<span style="color:rgb(13,175,99)">â– </span> Podzols (leached acidic)<br>
<span style="color:rgb(255,226,174)">â– </span> Regosols (unconsolidated)<br>
<span style="color:rgb(237,57,148)">â– </span> Solonchaks (saline)<br>
<span style="color:rgb(244,205,226)">â– </span> Solonetz (sodic)<br>
<span style="color:rgb(64,193,235)">â– </span> Stagnosols (periodically wet)<br>
<span style="color:rgb(97,143,130)">â– </span> Umbrisols (dark acidic)<br>
<span style="color:rgb(158,86,124)">â– </span> Vertisols (heavy clay)<br>
<i style="font-size:10px;color:#888">â˜… = classic wine terroir soils<br>Click map for soil identification</i>
</div>`;
document.querySelector('#map').parentElement.insertAdjacentHTML('beforeend',soilLegendHtml);

// Cropland legend
let cropLegendHtml=`
<div style="position:absolute;top:10px;left:10px;z-index:10000;background:rgba(22,33,62,.9);border:1px solid #555;border-radius:6px;padding:8px 12px;font-size:11px;color:#ccc;display:none;line-height:1.8;max-width:240px" id="crop-legend">
<b style="color:#d4af37">Land Cover (CORINE 2018)</b><br>
<i style="font-size:10px;color:#aaa">Europe only â€” official EEA colors</i><br>
<b style="font-size:10px;color:#aaa">Urban:</b><br>
<span style="color:#e6004d">â– </span> Continuous urban<br>
<span style="color:#ff0000">â– </span> Discontinuous urban<br>
<span style="color:#cc4df2">â– </span> Industrial / commercial<br>
<b style="font-size:10px;color:#aaa">Agriculture:</b><br>
<span style="color:#ffffa8">â– </span> Arable land<br>
<span style="color:#e68000">â– </span> Vineyards<br>
<span style="color:#f2a64d">â– </span> Fruit trees / berries<br>
<span style="color:#e6a600">â– </span> Olive groves<br>
<span style="color:#e6e64d">â– </span> Pastures<br>
<span style="color:#ffe64d">â– </span> Complex cultivation<br>
<b style="font-size:10px;color:#aaa">Forest / natural:</b><br>
<span style="color:#80ff00">â– </span> Broad-leaved forest<br>
<span style="color:#00a600">â– </span> Coniferous forest<br>
<span style="color:#ccf24d">â– </span> Natural grassland<br>
<b style="font-size:10px;color:#aaa">Water:</b><br>
<span style="color:#80f2e6">â– </span> Water bodies<br>
<i style="font-size:10px;color:#888">Zoom in for vineyard detail</i>
</div>`;
document.querySelector('#map').parentElement.insertAdjacentHTML('beforeend',cropLegendHtml);
</script>

</body>
</html>